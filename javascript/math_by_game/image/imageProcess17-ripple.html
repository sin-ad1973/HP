<!DOCTYPE html>
<html>
        <head>
                <meta charset="utf-8"/>
                <title>Image Processing</title>
                <script>
                    var ctx, src, imt;
            
                    function init() {
                        var canvas = document.getElementById("field");
                        ctx = canvas.getContext("2d");
            
                        var pic = document.getElementById("picture");
                        ctx.drawImage(pic, 0, 0, 250, 250);

                        src = ctx.getImageData(0, 0, 250, 250);
                        img = ctx.createImageData(250, 250);

                        processImage();
                        paint();
                    }

                    // 波紋
                    function processImage() {
                        var angle = 5;
                        var nWaves = 25;
                        var angleRadian = angle * Math.PI * 2 / 360;
                        var maxDistance = Math.sqrt(250 * 250 + 250 * 250);
                        var scale = (Math.PI * 2.0 * nWaves) / maxDistance;

                        for (var y = 0; y < 250; y++) {
                            for (var x = 0; x < 250; x++) {

                                // 画像(250*250)の中心を軸に回転させるため、
                                // 原点(0, 0)を中心とする座標に変換する((250/2)を減算)
                                var cy = y - 125;
                                var cx = x - 125;
                                var a = Math.sin(Math.sqrt(cx * cx + cy * cy) * scale) * angleRadian;
                                var cos = Math.cos(a); // cosθ
                                var sin = Math.sin(a); // sinθ
                                // 回転行列による回転後座標計算
                                // (cosθ, -sinθ) (x)
                                // (sinθ,  cosθ) (y)
                                var xs = Math.floor((cos * cx - sin * cy) + 125);
                                var ys = Math.floor((sin * cx + cos * cy) + 125);

                                if (xs >= 0 && xs < 250 && ys >= 0 && ys < 250) {
                                    var i = (y * 250 + x) * 4;
                                    var j = (ys * 250 + xs) * 4;
                                    img.data[i + 0] = src.data[j + 0];  // R
                                    img.data[i + 1] = src.data[j + 1];  // G
                                    img.data[i + 2] = src.data[j + 2];  // B
                                    img.data[i + 3] = 0xff;  // A
                                }
                            }
                        }
                    }

                    function paint() {
                        ctx.putImageData(img , 0, 0);
                    }
                </script>
            </head>
            <body onload="init()">
                <canvas id="field" width="250" height="250"></canvas>
                <img id="picture" src="picture0.jpg" style="display:none" />
            </body>
</html>
